-- Roblox Lua Script for "The Intruder - Mineshaft" Map (By BMF)
-- LocalScript handles UI, cheats, ESPs, and utility buttons

--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local StarterGui = game:GetService("StarterGui")
local UIS = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local Camera = workspace.CurrentCamera

--// UI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false
ScreenGui.Name = "IntruderMineshaftUI"

local MainFrame = Instance.new("Frame")
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Size = UDim2.new(0, 300, 0, 400)
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -200)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Visible = true

local Title = Instance.new("TextLabel")
Title.Parent = MainFrame
Title.Text = "The Intruder - Mineshaft (By BMF)"
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18

local ErrorLog = Instance.new("TextLabel")
ErrorLog.Parent = MainFrame
ErrorLog.Text = "Error Log: None"
ErrorLog.Size = UDim2.new(1, 0, 0, 30)
ErrorLog.Position = UDim2.new(0,0,0,35)
ErrorLog.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
ErrorLog.TextColor3 = Color3.fromRGB(255, 85, 85)
ErrorLog.Font = Enum.Font.SourceSans
ErrorLog.TextSize = 14
ErrorLog.TextWrapped = true
ErrorLog.TextYAlignment = Enum.TextYAlignment.Top

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = MainFrame
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0,5)

--// Toggle UI
UIS.InputBegan:Connect(function(input, processed)
	if not processed and input.KeyCode == Enum.KeyCode.Delete then
		MainFrame.Visible = not MainFrame.Visible
	end
end)

--// Function to create buttons
local function createButton(name, callback)
	local Button = Instance.new("TextButton")
	Button.Parent = MainFrame
	Button.Text = name
	Button.Size = UDim2.new(1,0,0,30)
	Button.BackgroundColor3 = Color3.fromRGB(40,40,40)
	Button.TextColor3 = Color3.fromRGB(255,255,255)
	Button.Font = Enum.Font.SourceSans
	Button.TextSize = 16
	Button.MouseButton1Click:Connect(function()
		local success, err = pcall(callback)
		if not success then
			ErrorLog.Text = "Error Log: "..tostring(err)
		end
	end)
	return Button
end

--// ESP Helpers

-- Highlight helper
local function highlightTarget(target, color)
	if target:FindFirstChildOfClass("Highlight") then return end
	local highlight = Instance.new("Highlight")
	highlight.Adornee = target
	highlight.FillColor = color
	highlight.FillTransparency = 0.5
	highlight.OutlineColor = Color3.fromRGB(255,255,255)
	highlight.OutlineTransparency = 0
	highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	highlight.Parent = target
end

-- Tracer helper
local function createTracer(target, color)
	local line = Drawing.new("Line")
	line.Visible = true
	line.Color = color
	line.Thickness = 2
	local connection
	connection = RunService.RenderStepped:Connect(function()
		if target and target:FindFirstChild("HumanoidRootPart") and target:FindFirstChildOfClass("Humanoid") then
			local hrp = target:FindFirstChild("HumanoidRootPart")
			local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
			if onScreen then
				line.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y) -- bottom center
				line.To = Vector2.new(pos.X, pos.Y)
				line.Visible = true
			else
				line.Visible = false
			end
		else
			line.Visible = false
			connection:Disconnect()
			line:Remove()
		end
	end)
end

-- Billboard name tag helper
local function createNameTag(target, text, color)
	if target:FindFirstChild("NameTag") then return end
	local billboard = Instance.new("BillboardGui")
	billboard.Name = "NameTag"
	billboard.Size = UDim2.new(0,200,0,50)
	billboard.StudsOffset = Vector3.new(0,3,0)
	billboard.AlwaysOnTop = true
	billboard.MaxDistance = 500
	billboard.Parent = target

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1,0,1,0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = color
	label.TextStrokeTransparency = 0
	label.TextScaled = true
	label.Font = Enum.Font.SourceSansBold
	label.Parent = billboard
end

--// Buttons

-- Infinite Yield
createButton("Infinite Yield", function()
	loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source"))()
end)

-- Dark Dex
createButton("Dark Dex", function()
	loadstring(game:HttpGet("https://raw.githubusercontent.com/infyiff/backup/main/dex.lua"))()
end)

-- Win Game (WIP)
createButton("Win Game (WIP)", function()
	print("Win Game feature coming soon!")
end)

-- God Mode (WIP)
createButton("God Mode (WIP)", function()
	print("God Mode feature coming soon!")
end)

createButton("Infinite Stamina (WIP)", function()
	local Players = game:GetService("Players")
	local UIS = game:GetService("UserInputService")
	local LocalPlayer = Players.LocalPlayer
	local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
	local Humanoid = Character:WaitForChild("Humanoid")

	-- Destroy Regen paths
	local function safeDestroy(path)
		if path and path.Destroy then
			pcall(function() path:Destroy() end)
		end
	end

	safeDestroy(game:GetService("Players").LocalPlayer:FindFirstChild("PlayerGui") and game:GetService("Players").LocalPlayer.PlayerGui:FindFirstChild("Stamina") and game:GetService("Players").LocalPlayer.PlayerGui.Stamina:FindFirstChild("StaminaDisplay") and game:GetService("Players").LocalPlayer.PlayerGui.Stamina.StaminaDisplay:FindFirstChild("Regen"))
	safeDestroy(game:GetService("StarterGui"):FindFirstChild("Stamina") and game:GetService("StarterGui").Stamina:FindFirstChild("StaminaDisplay") and game:GetService("StarterGui").Stamina.StaminaDisplay:FindFirstChild("Regen"))

	-- Infinite stamina setup
	local staminaGui = game:GetService("StarterGui"):FindFirstChild("Stamina")
	if staminaGui then
		local display = staminaGui:FindFirstChild("StaminaDisplay")
		if display then
			local current = display:FindFirstChild("Current")
			local active = display:FindFirstChild("Active")
			if current and active then
				spawn(function()
					while true do
						pcall(function()
							current.Value = 100
							active.Value = false
						end)
						wait(0.1)
					end
				end)
				print("Infinite Stamina enabled!")
			else
				ErrorLog.Text = "Error Log: Current or Active value not found."
			end
		else
			ErrorLog.Text = "Error Log: StaminaDisplay not found."
		end
	else
		ErrorLog.Text = "Error Log: Stamina GUI not found."
	end

	-- Shift-based speed control
	local shiftHeld = false

	UIS.InputBegan:Connect(function(input, gameProcessed)
		if gameProcessed then return end
		if input.KeyCode == Enum.KeyCode.LeftShift then
			shiftHeld = true
			Humanoid.WalkSpeed = 16
		end
	end)

	UIS.InputEnded:Connect(function(input)
		if input.KeyCode == Enum.KeyCode.LeftShift then
			shiftHeld = false
			Humanoid.WalkSpeed = 8
		end
	end)
end)

-- Teleport Helper
local function tpTo(pos)
    local plr = game.Players.LocalPlayer
    if plr and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
        plr.Character.HumanoidRootPart.CFrame = CFrame.new(pos)
    end
end

-- TP Buttons
createButton("TP to Gen 1", function()
    tpTo(Vector3.new(49, 4, -87))
end)

createButton("TP to Gen 2", function()
    tpTo(Vector3.new(131, 4, -88))
end)

createButton("TP to Gen 3", function()
    tpTo(Vector3.new(127, 4, 32))
end)

createButton("TP to Gen 4", function()
    tpTo(Vector3.new(29, 4, 60))
end)

createButton("TP to Gen 5", function()
    tpTo(Vector3.new(154, 4, 60))
end)

-- Full Bright
createButton("Full Bright", function()
	Lighting.Brightness = 5
	Lighting.ClockTime = 14
	Lighting.FogEnd = 100000
	Lighting.GlobalShadows = false
	Lighting.OutdoorAmbient = Color3.new(1,1,1)
	print("Full Bright activated!")
end)

createButton("Never Fail Generators", function()
    -- Remove puzzle UI (local copy)
    local plr = game:GetService("Players").LocalPlayer

    local function safeDestroy(obj)
        if obj and obj.Destroy then
            obj:Destroy()
        end
    end

    -- PlayerGui puzzle
    safeDestroy(plr:FindFirstChild("PlayerGui") and plr.PlayerGui:FindFirstChild("Puzzle"))

    -- Backpack explode
    safeDestroy(plr:FindFirstChild("Backpack") and plr.Backpack:FindFirstChild("Explode"))

    -- StarterGui
    safeDestroy(game:GetService("StarterGui"):FindFirstChild("Puzzle"))

    -- StarterPack explode
    safeDestroy(game:GetService("StarterPack"):FindFirstChild("Explode"))
end)

-- Intruder ESP
createButton("Intruder ESP", function()
	local intruder = workspace:WaitForChild("Intruder")
	if intruder and intruder:IsA("Model") then
		highlightTarget(intruder, Color3.fromRGB(255,0,0))
		createTracer(intruder, Color3.fromRGB(255,0,0))
		createNameTag(intruder, "Intruder", Color3.fromRGB(255,0,0))
	end
end)

-- Generator ESP (with proper tracers)
createButton("Generator ESP", function()
	local gensFolder = workspace:WaitForChild("Generators")
	for _, gen in pairs(gensFolder:GetChildren()) do
		local mainPart = nil
		if gen:IsA("Model") then
			mainPart = gen.PrimaryPart or gen:FindFirstChildWhichIsA("BasePart")
		elseif gen:IsA("BasePart") then
			mainPart = gen
		end

		if mainPart then
			-- Highlight
			highlightTarget(gen, Color3.fromRGB(255,255,0))

			-- Tracer
			local line = Drawing.new("Line")
			line.Visible = true
			line.Color = Color3.fromRGB(255,255,0)
			line.Thickness = 2
			local conn
			conn = RunService.RenderStepped:Connect(function()
				if mainPart then
					local pos, onScreen = Camera:WorldToViewportPoint(mainPart.Position)
					if onScreen then
						line.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
						line.To = Vector2.new(pos.X, pos.Y)
						line.Visible = true
					else
						line.Visible = false
					end
				else
					line.Visible = false
					conn:Disconnect()
					line:Remove()
				end
			end)

			-- BillboardGui
if not gen:FindFirstChild("NameTag") then
    local gui = Instance.new("BillboardGui")
    gui.Name = "NameTag"
    gui.Size = UDim2.new(0,200,0,80) -- made slightly taller
    gui.StudsOffset = Vector3.new(0,4,0)
    gui.AlwaysOnTop = true
    gui.MaxDistance = 500
    gui.Parent = gen

    -- ✅ NEW: Generator Name Label (top)
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1,0,0.33,0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.fromRGB(255,255,0)
    nameLabel.TextStrokeTransparency = 0.2
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.TextScaled = true
    nameLabel.Text = "Generator " .. tostring(gen.Name)
    nameLabel.Parent = gui

    -- Health label (middle)
    local healthLabel = Instance.new("TextLabel")
    healthLabel.Position = UDim2.new(0,0,0.33,0)
    healthLabel.Size = UDim2.new(1,0,0.33,0)
    healthLabel.BackgroundTransparency = 1
    healthLabel.TextColor3 = Color3.fromRGB(255,255,0)
    healthLabel.TextStrokeTransparency = 0.2
    healthLabel.Font = Enum.Font.SourceSansBold
    healthLabel.TextScaled = true
    healthLabel.Parent = gui

    -- In-use label (bottom)
    local usingLabel = Instance.new("TextLabel")
    usingLabel.Position = UDim2.new(0,0,0.66,0)
    usingLabel.Size = UDim2.new(1,0,0.33,0)
    usingLabel.BackgroundTransparency = 1
    usingLabel.TextColor3 = Color3.fromRGB(255,255,0)
    usingLabel.TextStrokeTransparency = 0.2
    usingLabel.Font = Enum.Font.SourceSansBold
    usingLabel.TextScaled = true
    usingLabel.Parent = gui

    -- Values
    local health = gen:WaitForChild("health")
    local inUse = gen:WaitForChild("inUse")
    local plrUsing = gen:WaitForChild("plrUsing")

    RunService.RenderStepped:Connect(function()
        pcall(function()
            healthLabel.Text = "Health: "..tostring(health.Value)
            if inUse.Value == true then
                usingLabel.Text = "Being used by "..tostring(plrUsing.Value)
            else
                usingLabel.Text = ""
            end
        end)
    end)
end

-- Kill the Intruder
createButton("Kill the Intruder", function()
	local intruder = workspace:FindFirstChild("Intruder")
	if intruder then
		intruder:Destroy()
		print("Intruder destroyed!")
	else
		ErrorLog.Text = "Error Log: Intruder not found."
	end
end)

-- Return to Lift
createButton("Return to Lift", function()
	local char = LocalPlayer.Character
	if char and char:FindFirstChild("HumanoidRootPart") then
		char.HumanoidRootPart.CFrame = CFrame.new(28,4,-39)
	end
end)

print("The Intruder - Mineshaft Script Loaded Successfully")
